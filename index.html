<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
		<title>Html5 buggy</title>
		<!--[if IE]><script type="text/javascript" src="vendor/box2d/lib/excanvas.js"></script><![endif]-->
		<script src="vendor/box2d/lib/prototype-1.6.0.2.js"></script>
		<script src="box2djs.js"></script>
		<script src="easyBox2djs.js"></script>

		<script src="js/jquery.min.js"></script>
		<script src="js/jquery.hotkeys.js"></script>
		
		<script type="text/javascript">
			jQuery.noConflict();
			var world;
			var ctx;
			var canvasWidth;
			var canvasHeight;
			var canvasTop;
			var canvasLeft;
			
			function drawWorld(world, context) {
				for (var j = world.m_jointList; j; j = j.m_next) {
					drawJoint(j, context);
				}
				for (var b = world.m_bodyList; b; b = b.m_next) {
					for (var s = b.GetShapeList(); s != null; s = s.GetNext()) {
						drawShape(s, context);
					}
				}		
			}
			
			function drawJoint(joint, context) {
				var b1 = joint.m_body1;
				var b2 = joint.m_body2;
				var x1 = b1.m_position;
				var x2 = b2.m_position;
				var p1 = joint.GetAnchor1();
				var p2 = joint.GetAnchor2();
				context.strokeStyle = '#00eeee';
				context.beginPath();
				switch (joint.m_type) {
				case b2Joint.e_distanceJoint:
					context.moveTo(p1.x, p1.y);
					context.lineTo(p2.x, p2.y);
					break;
			
				case b2Joint.e_pulleyJoint:
					// TODO
					break;
			
				default:
					if (b1 == world.m_groundBody) {
						context.moveTo(p1.x, p1.y);
						context.lineTo(x2.x, x2.y);
					}
					else if (b2 == world.m_groundBody) {
						context.moveTo(p1.x, p1.y);
						context.lineTo(x1.x, x1.y);
					}
					else {
						context.moveTo(x1.x, x1.y);
						context.lineTo(p1.x, p1.y);
						context.lineTo(x2.x, x2.y);
						context.lineTo(p2.x, p2.y);
					}
					break;
				}
				context.stroke();
			}
			
			function drawShape(shape, context) {
				context.strokeStyle = '#ffffff';
				if (shape.density == 1.0) {
					context.fillStyle = "red";
				} else {
					context.fillStyle = "black";
				}
				context.beginPath();
				switch (shape.m_type) {
				case b2Shape.e_circleShape:
					{
						var circle = shape;
						var pos = circle.m_position;
						var r = circle.m_radius;
						var segments = 16.0;
						var theta = 0.0;
						var dtheta = 2.0 * Math.PI / segments;
						
						// draw circle
						context.moveTo(pos.x + r, pos.y);
						for (var i = 0; i < segments; i++) {
							var d = new b2Vec2(r * Math.cos(theta), r * Math.sin(theta));
							var v = b2Math.AddVV(pos, d);
							context.lineTo(v.x, v.y);
							theta += dtheta;
						}
						context.lineTo(pos.x + r, pos.y);
				
						// draw radius
						context.moveTo(pos.x, pos.y);
						var ax = circle.m_R.col1;
						var pos2 = new b2Vec2(pos.x + r * ax.x, pos.y + r * ax.y);
						context.lineTo(pos2.x, pos2.y);
					}
					break;
				case b2Shape.e_polyShape:
					{
						var poly = shape;
						var tV = b2Math.AddVV(poly.m_position, b2Math.b2MulMV(poly.m_R, poly.m_vertices[0]));
						context.moveTo(tV.x, tV.y);
						for (var i = 0; i < poly.m_vertexCount; i++) {
							var v = b2Math.AddVV(poly.m_position, b2Math.b2MulMV(poly.m_R, poly.m_vertices[i]));
							context.lineTo(v.x, v.y);
						}
						context.lineTo(tV.x, tV.y);
					}
					break;
				}
				context.fill();
				context.stroke();
			}

			function createWorld() {
				var worldAABB	= new b2AABB();
				worldAABB.minVertex.Set(-1000, -1000);
				worldAABB.maxVertex.Set(2000, 1000);
				
				var gravity	= new b2Vec2(0, 500);
				var doSleep	= true;
				world		= new b2World(worldAABB, gravity, doSleep);
				return world;
			}		

			function createGround(world) {
				var groundSd	= new b2BoxDef();
				groundSd.extents.Set(800, 30);
				groundSd.restitution	= 0.2;
				var groundBd	= new b2BodyDef();
				groundBd.AddShape(groundSd);
				groundBd.position.Set(800, 470);
				return world.CreateBody(groundBd);
			}
			
			function step(cnt) {
				var stepping	= false;
				var timeStep	= 1.0/60;
				var iteration	= 1;
				
				world.Step(timeStep, iteration);
				ctx.clearRect(0, 0, canvasWidth, canvasHeight);
				drawWorld(world, ctx);
				
				setTimeout('step(' + (cnt || 0) + ')', 10);
			}
			
			
			function createObstacle(world, shapeW, shapeH, posX, posY, rotation){
				var boxSd	= new b2BoxDef();
				boxSd.density		= 0; 
				boxSd.restitution	= 0.0;
				boxSd.friction		= 1.0;
				boxSd.localRotation	= rotation;
				boxSd.extents.Set(shapeW, shapeH);
				var boxBd	= new b2BodyDef();
				boxBd.AddShape(boxSd);
				boxBd.position.Set(posX, posY);
				var boxBody	= world.CreateBody(boxBd)
				return boxBody;
			}
			
			function createObstacles(world){
				createObstacle(world, 80, 10, 500, 440, 0.9*Math.PI)
			}
			
			function createPolyGround(world){
				var points	= [[550, -10], [2000, 0], [2000, 60], [0, 60], [0, 0]];
				var polySd	= new b2PolyDef();
				polySd.restitution	= 0.2;
				polySd.vertexCount	= points.length;
				for (var i = 0; i < points.length; i++) {
					polySd.vertices[i].Set(points[i][0], points[i][1]);
				}				
				var bodyDef	= new b2BodyDef();
				bodyDef.AddShape(polySd);
				bodyDef.position.Set(0, 440);
				var body	= world.CreateBody(bodyDef)
				return body;
			}

			function createDust(world){
				// add random shit //
				circleDef = new b2CircleDef();
				circleDef.density	= 0.01;
				circleDef.friction	= 0.1;
				circleDef.restitution	= 1;
				
				for (i = 0; i < 10; i++) {
					circleDef.radius = Math.random()*3+1;
					
					bodyDef = new b2BodyDef();
					bodyDef.allowSleep	= true;
					bodyDef.linearDamping	= 0.1;
					bodyDef.angularDamping	= 0.1;
					bodyDef.AddShape(circleDef);
					bodyDef.position.Set(Math.floor(Math.random()*2000), 420);
								
					body = world.CreateBody(bodyDef);
				}
			}

			function createBall(world, x, y) {
				var ballSd = new b2CircleDef();
				ballSd.density	= 1.0;
				ballSd.radius	= 20;
				ballSd.restitution = 0.0;
				ballSd.friction = 0.5;
				var ballBd = new b2BodyDef();
				ballBd.AddShape(ballSd);
				ballBd.position.Set(x,y);
				return world.CreateBody(ballBd);
			}
			
			function createCar(world, x, y) {
				var wheelRadius	= 20;
				
				// create one wheel
				var wheel1Sd		= new b2CircleDef();
				wheel1Sd.density	= 1.0;
				wheel1Sd.radius		= wheelRadius;
				wheel1Sd.restitution	= 0.0;
				wheel1Sd.friction	= 1.3;
				var wheel1Bd		= new b2BodyDef();
				wheel1Bd.AddShape(wheel1Sd);
				wheel1Bd.position.Set(50, 60);
				var wheel1Body	= world.CreateBody(wheel1Bd)

				// create one wheel
				var wheel2Sd		= new b2CircleDef();
				wheel2Sd.density	= 1.0;
				wheel2Sd.radius		= wheelRadius;
				wheel2Sd.restitution	= 0.3;
				wheel2Sd.friction	= 1.3;
				var wheel2Bd		= new b2BodyDef();
				wheel2Bd.AddShape(wheel2Sd);
				wheel2Bd.position.Set(110, 60);
				var wheel2Body	= world.CreateBody(wheel2Bd)

				//eb2Box().attr({
				//	density		: 0.5,
				//	restitution	: 0,
				//	friction	: 1.0
				//}).toBody().position(80, 30)
				
				var slota	= eb2BoxDef().density(0.5).restitution(0).friction(1.0).size(50, 10).toBody().position(800, 30).toWorld(world)
				//var slota	= eb2BoxDef().density(3).toBody();
				console.log("slota", slota)
				

				// cart
				var carSd	= new b2BoxDef();
				carSd.density		= 0.5; 
				carSd.restitution	= 0.0;
				carSd.friction		= 1.0;
				carSd.extents.Set(50, 10);
				
				var carBd	= new b2BodyDef();
				carBd.AddShape(carSd);
				carBd.position.Set(80,30);
				var carBody	= world.CreateBody(carBd)


				var joint1Def = new b2RevoluteJointDef();
				joint1Def.anchorPoint.Set(50, 60);
				joint1Def.body1 = carBody;
				joint1Def.body2 = wheel1Body;
				joint1Def.motorSpeed	= 0.0 * Math.PI;
				joint1Def.motorTorque	= 5000000.0;
				joint1Def.enableMotor	= true;
				var joint1	= world.CreateJoint(joint1Def);
				
				var joint2Def = new b2RevoluteJointDef();
				joint2Def.anchorPoint.Set(110, 60);
				joint2Def.body1 = carBody;
				joint2Def.body2 = wheel2Body;
				joint2Def.motorSpeed	= 0 * Math.PI;
				joint2Def.motorTorque	= 5000000.0;
				joint2Def.enableMotor	= true;	
				var joint2	= world.CreateJoint(joint2Def);
				
				////
				//eb2RevoluteJoint().anchorPoint(110, 60)
				//	.body(carBody, wheel2Body)
				//	.motor(0*Math.PI, 5000000.0).toBody();

				jQuery(document).bind('keydown', 'right',function (evt){					
					joint1.m_enableMotor	= false;
					joint2.m_enableMotor	= true;
					joint2.m_motorSpeed	= 4.0 * Math.PI;
					return false;
				});
				jQuery(document).bind('keyup', 'right',function (evt){
					joint1.m_enableMotor	= false;
					joint2.m_enableMotor	= true;
					joint2.SetMotorSpeed(0 * Math.PI);				
					return false;
				});
				jQuery(document).bind('keydown', 'left',function (evt){					
					joint2.m_enableMotor	= false;
					joint1.m_enableMotor	= true;
					joint1.m_motorSpeed	= -4.0 * Math.PI;
					return false;
				});
				jQuery(document).bind('keyup', 'left',function (evt){
					joint2.m_enableMotor	= false;
					joint1.m_enableMotor	= true;
					joint1.SetMotorSpeed(0 * Math.PI);				
					return false;
				});
			}

			// main entry point
			Event.observe(window, 'load', function() {
				ctx		= $('canvas').getContext('2d');
				var canvasElm	= $('canvas');
				canvasWidth	= parseInt(canvasElm.width);
				canvasHeight	= parseInt(canvasElm.height);
				canvasTop	= parseInt(canvasElm.style.top);
				canvasLeft	= parseInt(canvasElm.style.left);
				
				world		= createWorld();		
				
				createGround(world);
				//createPolyGround(world);
				createCar(world, 50, 300);
				createDust(world)
				createObstacles(world);

				step();
			});
			</script>
	</head>
	<body style="margin:0px;">
		<canvas id="canvas" width='1200' height='500' style="background-color:#eeeeee;"></canvas>
	</body>

 </html>
		
